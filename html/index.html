<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Main Page</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li class="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1></h1>
<p>
<h1>LunaService</h1>
<p>
<em>Example client usage:</em><p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">bool</span> retVal;
<a class="code" href="structLSError.html" title="Error object which contains information about first error since it was initialized...">LSError</a> lserror;
LSErrorInit(&amp;lserror);

<a class="code" href="group__LunaService.html#g0b60fe350307028da1fcd5d14d35730d" title="Handle to service.">LSHandle</a> *serviceHandle;
retVal = LSRegister(NULL, &amp;serviceHandle, &amp;lserror);
<span class="keywordflow">if</span> (!retVal) <span class="keywordflow">goto</span> error;

retVal = LSCall(serviceHandle, <span class="stringliteral">"luna://com.palm.contacts/category/listContacts"</span>,
        <span class="stringliteral">"{ \"json payload\" }"</span>, listContactsHandler, user_data, &amp;token, &amp;lserror);
<span class="keywordflow">if</span> (!retVal) <span class="keywordflow">goto</span> error;

LSGmainAttach(serviceHandle, gmainLoop, &amp;lserror); 
g_main_loop_run(gmainLoop);
</pre></div><p>
<em>Example service usage.</em><p>
<div class="fragment"><pre class="fragment"><span class="comment">// callback</span>
<span class="keyword">static</span> <span class="keywordtype">bool</span>
listContacts(<a class="code" href="group__LunaService.html#g0b60fe350307028da1fcd5d14d35730d" title="Handle to service.">LSHandle</a> *sh, <a class="code" href="group__LunaService.html#g8d52e9041659e6c91b5fd004b976123f" title="Message object.">LSMessage</a> *message)
{
     <a class="code" href="group__LunaService.html#g8d52e9041659e6c91b5fd004b976123f" title="Message object.">LSMessage</a> *reply = NULL;

     <span class="keywordtype">bool</span> retVal;
     <a class="code" href="structLSError.html" title="Error object which contains information about first error since it was initialized...">LSError</a> lserror;
     LSErrorInit(&amp;lserror);

     retVal = LSMessageReply(sh, message, <span class="stringliteral">"{ JSON REPLY PAYLOAD }"</span>, &amp;lserror);
     <span class="keywordflow">if</span> (!retVal)
     {
         LSErrorPrint(&amp;lserror, stderr);
         LSErrorFree(&amp;lserror);
     }

     <span class="keywordflow">return</span> retVal;
}

<span class="keyword">static</span> LSMethod ipcMethods[] = {
   { <span class="stringliteral">"listContacts"</span>, listContacts },
   { },
};
...

<span class="comment">// Service registration thread</span>
bool retVal;
<a class="code" href="structLSError.html" title="Error object which contains information about first error since it was initialized...">LSError</a> lserror;
LSErrorInit(&amp;lserror);

<a class="code" href="group__LunaService.html#g0b60fe350307028da1fcd5d14d35730d" title="Handle to service.">LSHandle</a> *serviceHandle;
retVal = LSRegister(<span class="stringliteral">"com.palm.contacts"</span>, &amp;serviceHandle, &amp;lserror);
<span class="keywordflow">if</span> (!retVal) <span class="keywordflow">goto</span> error;

retVal = LSRegisterCategory(serviceHandle, <span class="stringliteral">"/category"</span>,  ipcMethods, NULL, NULL, &amp;lserror);
<span class="keywordflow">if</span> (!retVal) <span class="keywordflow">goto</span> error;

retVal = LSGmainAttach(serviceHandle, gmainLoop, &amp;lserror); 
<span class="keywordflow">if</span> (!retVal) <span class="keywordflow">goto</span> error;

g_main_loop_run(gmainLoop);
</pre></div><p>
<em>Storing a message for replying in another thread.</em> <div class="fragment"><pre class="fragment">Queue messageQueue;
...

static <span class="keywordtype">bool</span>
listContacts(<a class="code" href="group__LunaService.html#g0b60fe350307028da1fcd5d14d35730d" title="Handle to service.">LSHandle</a> *sh, <a class="code" href="group__LunaService.html#g8d52e9041659e6c91b5fd004b976123f" title="Message object.">LSMessage</a> *message)
{
     <span class="keywordtype">bool</span> retVal;

     <a class="code" href="structLSError.html" title="Error object which contains information about first error since it was initialized...">LSError</a> lserror;
     LSErrorInit(&amp;lserror);

     LSMessageRef(message);

     queue(messageQueue, message);
}

...

void
SomeOtherThread()
{
    <a class="code" href="structLSError.html" title="Error object which contains information about first error since it was initialized...">LSError</a> lserror;
    LSErrorInit(&amp;lserror);

    <a class="code" href="group__LunaService.html#g8d52e9041659e6c91b5fd004b976123f" title="Message object.">LSMessage</a> *message = dequeue(messageQueue);
    ...
    <span class="keywordflow">if</span> (!LSMessageReply(sh, message, <span class="stringliteral">"{PAYLOAD IN JSON}"</span>, lserror))
    {
        LSErrorPrint(&amp;lserror);
        LSErrorFree(&amp;lserror);
    }

    ....
}
</pre></div><p>
<em>Example run loop via select. See LSCustomSelectExample() for latest example.</em><p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">bool</span> retVal;

<span class="keywordflow">do</span>
{
    <span class="keywordtype">int</span> nfd = -1;
    fd_set rdfds, wrfds, exfds;

    FD_ZERO(&amp;rdfds);
    FD_ZERO(&amp;wrfds);
    FD_ZERO(&amp;exfds);

    retVal = LSCustomGetFds(sh, &amp;nfd, &amp;rdfds, &amp;wrfds, &amp;exfds, lserror);
    <span class="keywordflow">if</span> (!retVal) <span class="keywordflow">return</span> -1;

    <span class="keywordtype">int</span> ret = select(nfd, &amp;rdfds, &amp;wrfds, &amp;exfds, NULL);
    <span class="keywordflow">if</span> (ret &lt; 0) 
    {
        perror(<span class="stringliteral">"select"</span>);
        <span class="keywordflow">break</span>;
    }

    <span class="comment">// Pull incoming bytes off socket and push outgoing bytes onto it.</span>
    retVal = LSCustomSendRecvBytes(sh, &amp;rdfds, &amp;wrfds, &amp;exfds, lserror);
    <span class="keywordflow">if</span> (!retVal)
    {
        <span class="keywordflow">break</span>;
    }

    <span class="comment">// Transmit byte and Dispatch incomming at most 1 message</span>
    retVal = LSCustomDispatchMessage(sh, NULL, lserror); 
    <span class="keywordflow">if</span> (!retVal)
    {
        <span class="keywordflow">break</span>;
    }

} <span class="keywordflow">while</span> (<span class="keyword">true</span>);
</pre></div><p>
<em>Example run loop via select if you want to handle messages directly.</em><p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">while</span> (serviceRunning)
{
    fd_set rdfds, wrfds, exfds;
    FD_ZERO(&amp;rdfds);
    FD_ZERO(&amp;wrfds);
    FD_ZERO(&amp;exfds);

    LSGetFd(serviceHandle, &amp;maxfd, &amp;rdfds, &amp;wrfds, &amp;exfds, &amp;lserror);

    ret = select(maxfd, &amp;rdfds, &amp;wrfds, &amp;exfds, NULL);
    <span class="keywordflow">if</span> (ret &gt; 0)
    {
        <a class="code" href="group__LunaService.html#g8d52e9041659e6c91b5fd004b976123f" title="Message object.">LSMessage</a> *message;
        <span class="keywordtype">char</span> *reply = NULL;

        LSMessageFetch(serviceHandle, &amp;message, &amp;lserror);

        <span class="keywordflow">if</span> (strcmp(LSMessageGetName(message), <span class="stringliteral">"listContacts"</span>))
        {
            <span class="keywordtype">char</span> *payload;
            payload = LSMessageGetPayload(message);
            ...
            reply = <span class="stringliteral">"{ JSON PAYLOAD }"</span>;
            LSMessageReply(serviceHandle, message, reply, &amp;lserror);
        }
    }
}
</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Sep 16 12:26:46 2009 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
